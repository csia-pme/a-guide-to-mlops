---
title: "Step 7: Track model evolutions in CI/CD pipeline with CML"
---

# {% $markdoc.frontmatter.title %}

## Summary

The purpose of this step is to track the model evolutions and generate reports directly in the CI/CD pipeline so it can be discussed collectively online before commiting the changes to the codebase.

{% callout type="note" %}
CML can do much more than just generating reports. Have a look to the [Train the model on a Kubernetes cluster with CML](/advanced-concepts/train-the-model-on-a-kubernetes-cluster-with-cml) guide.
{% /callout %}

## Instructions

{% callout type="warning" %}
This guide has been written for macOS and Linux operating systems in mind. If you use Windows, you might encounter issues. Please use a decent terminal ([GitBash](https://gitforwindows.org/) for instance) or a Windows Subsystem for Linux (WSL) for optimal results.
{% /callout %}

The reports generated by CML compare the current run with a target reference.

The target reference can be a specific commit (what are the differences between the current run and the run from the target commit) or a branch (what are the differences between the current run and the run from the target branch).

Many workflows exist to discuss and integrate the work done to a target reference. For the sake of simplicity, in this guide, we will present two methods that are commonly used on GitHub - Pull Requests (PRs) - and GitLab - Merge Requests (MRs) - to integrate the work done to the `main` branch.

### GitHub Actions

{% callout type="note" %}
Using GitLab? Go to the [GitLab CI](#gitlab-ci) section!
{% /callout %}

{% callout type="note" %}
Highly inspired by the [_Get Started with CML on GitHub_ - cml.dev](https://cml.dev/doc/start/github) [_Creating an issue_ - docs.github.com](https://docs.github.com/en/issues/tracking-your-work-with-issues/creating-an-issue) and [_Creating a branch to work on an issue_ - docs.github.com](https://docs.github.com/en/issues/tracking-your-work-with-issues/creating-a-branch-for-an-issue) guides and the [`example_cml` - github.com](https://github.com/iterative/example_cml) and [`cml_dvc_case` - github.com](https://github.com/iterative/cml_dvc_case) GitHub repositories.
{% /callout %}

Update the `.github/workflows/mlops.yml` file.

```yaml

```

This GitHub Workflow will create CML reports on each pushes that are related to a Pull Request.

Push the changes to Git.

```sh
# Add the updated workflow
git add .github/workflows/mlops.yml

# Commit the changes
git commit -m "Enable CML reports on pull requests"

# Push the changes
git push
```

Create a new issue by going to the **Issues** section from the top header of your GitHub repository. Select **New issue** and describe the work/improvements/ideas that you want to integrate to the codebase. In this guide, we will name the issue _Demonstrate step 7_. Create the issue by selecting **Submit new issue**.

The issue opens. Select **Create a branch for this issue or link a pull request** from the right sidebar. Create the branch by selecting **Create branch**. A new pop-up opens with the name of the branch you want to checkout to.

{% callout type="note" %}
Finished? Go to the [Make the changes to the model](#make-the-changes-to-the-model) section!
{% /callout %}

### GitLab CI

{% callout type="note" %}
Using GitHub? Go to the [GitHub Actions](#github-actions) section!
{% /callout %}

{% callout type="note" %}
Highly inspired by the [_Using CML on GitLab_ - cml.dev](https://cml.dev/doc/start/gitlab) and [_Personal access tokens_ - docs.gitlab.com](https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html) guides and the [`example_cml` - gitlab.com](https://gitlab.com/iterative.ai/example_cml) and the [`cml-dvc-case` - gitlab.com](https://gitlab.com/iterative.ai/cml-dvc-case) GitLab repositories.
{% /callout %}

_TODO_


```

report:
  stage: report
  image: iterativeai/cml:0-dvc2-base1
  needs:
    - job: run-ml-experiment
      artifacts: true
  script:
    # Compare params to default branch
    - echo "# Params" >> report.md
    - echo >> report.md
    # In a production settings, the next line should use $CI_DEFAULT_BRANCH instead of the 05-track-the-changes-made-to-a-model branch used in this guide
    - dvc params diff --show-md 05-track-the-changes-made-to-a-model >> report.md
    - echo >> report.md

    # Compare metrics to default branch
    - echo "# Metrics" >> report.md
    - echo >> report.md
    # In a production settings, the next line should use $CI_DEFAULT_BRANCH instead of the 05-track-the-changes-made-to-a-model branch used in this guide
    - dvc metrics diff --show-md 05-track-the-changes-made-to-a-model >> report.md
    - echo >> report.md

    # Visualize precision_recall diff
    - echo "# Precision-Recall" >> report.md
    - echo >> report.md
    # In a production settings, the next line should use $CI_DEFAULT_BRANCH instead of the 05-track-the-changes-made-to-a-model branch used in this guide
    - dvc plots diff --target evaluation/plots/precision_recall.json --show-vega 05-track-the-changes-made-to-a-model > vega.json
    - vl2png vega.json > precision_recall.png
    - cml-publish precision_recall.png --md --title 'precision_recall' >> report.md
    - echo >> report.md

    # Visualize roc diff
    - echo "# Receiver operating characteristic (ROC)" >> report.md
    - echo >> report.md
    # In a production settings, the next line should use $CI_DEFAULT_BRANCH instead of the 05-track-the-changes-made-to-a-model branch used in this guide
    - dvc plots diff --target evaluation/plots/roc.json --show-vega 05-track-the-changes-made-to-a-model > vega.json
    - vl2png vega.json > roc.png
    - cml-publish roc.png --md --title 'roc' >> report.md
    - echo >> report.md

    # Publish the CML report
    - cml send-comment report.md
```
```


{% callout type="note" %}
Finished? Go to the [Make the changes to the model](#make-the-changes-to-the-model) section!
{% /callout %}

### Make the changes to the model

Checkout the branch locally.

```sh
# Get the latest updates from the remote origin
git fetch origin

# Check to the new branch
git checkout <the name of the new branch>
```

Update the parameters to run the experiment in the `params.yaml` file.

```yaml
prepare:
  split: 0.25
  seed: 20170428

featurize:
  max_features: 500
  ngrams: 3

train:
  seed: 20170428
  n_est: 50
  min_split: 3
```

Run the experiment.

```sh
# Run the experiment. DVC will automatically run all required steps
dvc repro
```

Push the changes to DVC and Git.

```sh
# Upload the experiment data and cache to the remote bucket
dvc push

# Add all the files
git add .

# Commit the changes
git commit -m "I made some changes to the model"

# Push the changes
git push
```

Congrats! You now have a report that will be generated on each PR/MR that can be visualized and discussed with the rest of the team before integrating the changes to the common codebase.

{% callout type="note" %}
Want to see what the result of this step should look like? Have a look at the Git repository directory here: [step-7-track-model-evolutions-in-cicd-pipeline-with-cml](https://github.com/csia-pme/a-guide-to-mlops/tree/main/pages/the-guide/step-7-track-model-evolutions-in-cicd-pipeline-with-cml)
{% /callout %}

## State of the MLOps process

## Next & Previous steps

- **Previous**: [Step 6: Orchestrate the workflow with a CI/CD pipeline](/the-guide/step-6-orchestrate-the-workflow-with-a-cicd-pipeline)
- **Next**: [Step 8: Share and deploy model with MLEM](/the-guide/step-8-share-and-deploy-model-with-mlem)
